练习3：释放某虚地址所在的页并取消对应二级页表项的映射
  当释放一个包含某虚地址的物理内存页时，需要让对应此物理内存页的管理数据结构Page做相关的清除处理，使得此物理内存页成为空闲；另外还需把表示虚地址与物理地址对应关系的二级页表项清除。请仔细查看和理解page_remove_pte函数中的注释。为此，需要补全在 kern/mm/pmm.c中的page_remove_pte函数。

static inline void page_remove_pte(pde_t *pgdir, uintptr_t la, pte_t *ptep) {
    if ((*ptep & PTE_P)) {  //检查页表入口是否存在
        struct Page *page = pte2page(*ptep);  //将pte得到物理页面，再得到管理节点。
        if (page_ref_dec(page) == 0) { // 若引用计数减一后为0 则释放该物理页
            free_page(page);  //当引用为0的时候释放该页
        }
        //如果被多次引用，则不能释放此页，只用释放二级页表的表项
        *ptep = 0; // 清空 PTE的存在位,即将此页表项清零，表示该映射关系无效
        tlb_invalidate(pgdir, la); // 刷新 tlb，保证tlb中的缓存不会有错误的映射关系
    }
}
首先判断一下 ptep 是不是合法——检查一下 Present 位就是了；然后通过注释中所说的，通过 pte2page(*ptep) 获取相应页，减少引用计数并决定是否释放页；最后把 TLB 中该页的缓存刷掉就可以了。

  数据结构Page的全局变量（其实是一个数组）的每一项与页表中的页目录项和页表项有无对应关系？如果有，其对应关系是啥？

  可以参照 kern/mm/pmm.h 中的转换函数。其实就是 Page 全局数组中以 Page Directory Index 和 Page Table Index 的组合 PPN (Physical Page Number) 为索引的那一项。


思考题：

1）如何在建立页表的过程中维护全局段描述符表(GDT)和页表的关系,确保ucore能够在

各个时间段上都能正常寻址?

对于GDT进行简单功能描述（通过GDT的index得到段描述符）。在建立页表的时候，此时还是链接时由bootloader生成的GDT.在建立页表完成后，需要更新全局GDT.这才真正开启了分页机制。

2） 对于哪些物理内存空间需要建立页映射关系?


可用的物理空间。由此图的内存分布可以看出，我们可用物理空间起始地址是ucore的bss段结束地址上。

3) 具体的页映射关系是什么?

// +--------10------+-------10-------+---------12----------+ // | Page Directory | Page Table | Offset within Page | // | Index | Index | | // +----------------+----------------+---------------------+ ucore 的页式管理通过一个二级的页表实现。一级页表的起始物理地址存放在cr3寄存器中,这个地址必须是一个页对齐的地址,也就是低12位必须为 0。

拿到一个虚拟地址后，拿出pde index +基地址，得到pte的物理地址。然后该物理地址偏移个pte的index后，可以得到该虚拟页面的物理地址。

当看到这里的时候，我们可以清楚的知道存放在等于pte下索引为index的位置下的值在加上offset的到最终的对应物理地址。

4) 页目录表的起始地址设置在哪里?

VPT=0xFAC00000

pde_t * const vpd = (pde_t *)PGADDR(PDX(VPT), PDX(VPT), 0);

vpd就是页目录表的起始虚拟地址=0xFAFEB000。

5) 页表的起始地址设置在哪里,需要多大空间?

页表的理论连续虚拟地址空间0xFAC00000~0xFB000000,大小为4MB。因为这个连

续地址空间的大小为4MB,可有1M个PTE,即可映射4GB的地址空间。由于ucore的KERNTOP为3G+896MB,所以最大内核虚地址KERNTOP的页表项虚地址为:vpt+0xF8000000/0x1000*4=0xFAC00000+0xF8000*4=0xFAFE0000。

6) 如何设置页目录表项的内容?

通过页目录表项，我们可以得到该项页表的物理地址及其访问权限、状态等。

boot_pgdir[PDX(la)] = PADDR (页表物理地址) | PTE_P | PTE_W

7) 如何设置页表项的内容?

通过设置页表和对应的页表项，可建立虚拟内存地址和物理内存地址的对应关系

前面练习的get_pte函数是设置页表项环节中的一个重要步骤。此函数找到一个虚地址

对应的二级页表项的内核虚地址，如果此二级页表项不存在，则分配一个包含此项

的二级页表。


1、数据结构Page的全局变量(其实是一个数组)的每一项与页表中的页目录项和页表项有无对应关系?如果有,其对应关系是什么?
Page数组，用来管理物理页面的数据结构。每一个物理页面对应一个page元素。页目录项和页表项的前20位就可以表明他是哪个page。
存在对应关系：由于页表项中存放着对应的物理页的物理地址，因此可以通过这个物理地址来获取到对应到的Page数组的对应项，具体做法为将物理地址除以一个页的大小，然后乘上一个Page结构的大小获得偏移量，使用偏移量加上Page数组的基地址皆可以或得到对应Page项的地址


2、如果希望虚拟地址与物理地址相等,则需要如何修改lab2,完成此事?
1、使得页目录表起始虚地址等于其物理地址

2、建立虚拟页面与物理页面的映射关系，使得其为对等映射。

3、重新加载gdt。

如果需要虚拟地址和物理地址相等，可以考虑更新gdt，更新段映射，使得virtual address = linear address - 0xc0000000，这样的话就可以实现virtual address = physical address；
